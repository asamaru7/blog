<!DOCTYPE html>
<html>

<head>
	<title>php-fpm opcache로 인한 Nginx - 502 bad gateaway 오류</title>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<meta name="author" content="유영재">
	<meta name="keywords" content="php-fpm opcache로 인한 Nginx - 502 bad gateaway 오류,php,이 세상에 하나는 남기고 가자"/>
	<meta name="description" content="php-fpm opcache로 인한 Nginx - 502 bad gateaway 오류,php,얼마 전부터 서비스 사용자로부터 이상한 오류 보고를 비주기적으로 받고 있다.특정 페이지에 접속시 502 Bad gateaway 오류가 난다는 것이다. 하지만 그 오류가 나는 페이지에 특별히 눈에 띄는 부분은 없다. 게다가 동일한 프로그램이 몇개의 폴더에서 동시에 사용 중임에도 꼭 ..."/>

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- http://opengraphprotocol.org/ -->
	<meta name="twitter:card" content="summary_large_image">
	<meta property="og:type" content="website">
	<meta property="og:url" content="https://blog.asamaru.net/2016/04/12/php-fpm-opcache-and-nginx-502-bad-gateaway/">
	<meta property="og:title" content="php-fpm opcache로 인한 Nginx - 502 bad gateaway 오류">
	

	<link rel="canonical" href="https://blog.asamaru.net/2016/04/12/php-fpm-opcache-and-nginx-502-bad-gateaway/"/>
	<link rel="shortcut icon" type="image/x-icon" media="screen" href="https://blog.asamaru.net/favicon.ico"/>
	<link rel="alternate" type="application/rss+xml" title="이 세상에 하나는 남기고 가자" href="https://blog.asamaru.net/atom.xml"/>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="https://blog.asamaru.net/static/css/style.css"/>
	<link rel="stylesheet" type="text/css" href="https://blog.asamaru.net/static/css/highlight.css"/>

	
	<link rel="stylesheet" type="text/css" href="https://blog.asamaru.net/static/css/post.css"/>
	
	

	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
					(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-65749108-2', 'auto');
		ga('send', 'pageview');

	</script>
</head>


<body>
<div class="main">

	<nav class="navbar navbar-default" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">이 세상에 하나는 남기고 가자</a>
		</div>

		<div class="navbar-collapse collapse">
			
			<ul class="nav navbar-nav">
				<li class="active">
				<a rel="index" href="/">Blog</a>
				</li>
				<li >
				<a href="/archives/">Archives</a>
				</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a class="subscribe-rss" href="https://blog.asamaru.net/atom.xml" title="subscribe via RSS">
						<span class="visible-xs">RSS</span>
						<img class="hidden-xs" src="/static/img/rss.png" alt="RSS">
					</a>
				</li>
			</ul>
			
			<!-- <form class="navbar-form navbar-right" action="http://www.google.co.kr" id="cse-search-box" target="_blank">
			  <div class="form-group">
			    <input type="hidden" name="cx" value="partner-pub-8163803188491150:6044663021" />
			    <input type="hidden" name="ie" value="UTF-8" />
			    <input type="text" name="q" class="form-control" />
			    <input type="submit" name="sa" value="&#xac80;&#xc0c9;" />
			  </div>
			</form>
			<script type="text/javascript" src="http://www.google.co.kr/coop/cse/brand?form=cse-search-box&amp;lang=ko"></script> -->
			<form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
				<input type="hidden" name="sitesearch" value="https://blog.asamaru.net">
				<div class="form-group">
					<input class="form-control" type="text" name="q" placeholder="Search">
				</div>
			</form>
			
		</div>
	</div>
</nav>


	<div class="container">
		<div class="row">
	<div class="content col-lg-9">
		<div class="sheet post">
			<header>
				<h2>php-fpm opcache로 인한 Nginx - 502 bad gateaway 오류</h2>
				<p class="post-meta">
					<!--<span class="glyphicon glyphicon-calendar"></span>--> 2016.04.12.
					
					&nbsp;&nbsp;&nbsp;
					<span>
						<a href="https://blog.asamaru.net/category/php/"><span class="glyphicon glyphicon-list"></span>&nbsp;php</a>
					</span>
					<span>
                </span>
				</p>
			</header>
			<hr class="boundary">
			<article>
				<!-- Topic of Contents -->
				<!--
								<section class="panel panel-default cToc">
									<div class="panel-heading">
										<h3 class="panel-title">Topic of Contents</h3>
									</div>
									<ul class="list-group">
										<li class="list-group-item toc">
										</li>
									</ul>
								</section>
				-->

				<p>얼마 전부터 서비스 사용자로부터 이상한 오류 보고를 비주기적으로 받고 있다.</p>

<p>특정 페이지에 접속시 <code>502 Bad gateaway</code> 오류가 난다는 것이다. 하지만 그 오류가 나는 페이지에 특별히 눈에 띄는 부분은 없다. 게다가 동일한 프로그램이 몇개의 폴더에서 동시에 사용 중임에도 꼭 한군데서만 동일한 문제를 일으킨다. 게다가 일시적으로 발생하고 사라지지 않고 한번 오류가 발생하면 그 후에 해당 페이지에 접속하면 해결 전까지는 계속 502 에러를 보인다. 게다가 해당 오류가 발생하는 조건을 알 수 없어 오류 재연이 불가능한 상황이라 원인 파악에 애를 먹고 있다.</p>

<p>현재 해당 서버는 CentOS 6.7에 nginx + php-fpm으로 서비스 되고 있고 opcache와 apcu 등이 적용되어 있다. 오류가 난 상황에서는 로그에 아래와 같은 기록이 남는다.</p>

<p><strong>/var/log/nginx/error.log</strong></p>

<figure class='code'><div class="highlight notranslate"><pre><code class="nmcode">2016/04/12 14:50:43 [error] 2481#2481: *1828457 recv() failed (104: Connection reset by peer) while reading response header from upstream, client: ~~~.~~~.~~~.~~~, server: ~~~, request: "GET /~~~ HTTP/1.1", upstream: "fastcgi://~~~:", host: "~~~", referrer: "~~~"
</code></pre></div></figure>

<p><strong>/var/log/php-fpm/error.log</strong></p>

<figure class='code'><div class="highlight notranslate"><pre><code class="nmcode">[12-Apr-2016 14:54:39] WARNING: [pool www] child 24352 exited on signal 11 (SIGSEGV) after 301.965713 seconds from start
[12-Apr-2016 14:54:39] NOTICE: [pool www] child 24510 started
</code></pre></div></figure>

<p>현재로써는 일단 오류가 발생하면 해당 서버의 opcache를 초기화해주면 문제는 즉시 해결된다. 따라서 opcache의 오류로 판단하고 있다.</p>

<p>이 문제와 관련해서 검색해보니 비슷한 증상을 보이는 사례들이 많았다. 대부분의 경우 해결책은 opcache를 끄도록 설정하는 것을 제시하고 있다. 하지만 opcache는 당연히 필요하니 사용하던 것이라 그냥 끌수는 없다. 다른 방법으로 <a href="http://offandon.org/2015/12/apache-2-4-opcache-apcu-502/">Apache 2.4 + Opcache + APCu = 502?</a>에 보면 아래와 같은 방법을 제시하고 있다.</p>

<p><strong>/etc/php.d/opcache.ini:</strong></p>

<figure class='code'><div class="highlight notranslate"><pre><code class="nmcode">opcache.fast_shutdown=0
opcache.enable_cli=0
</code></pre></div></figure>

<p>하지만 <code>fast_shutdown</code>의 경우도 성능을 위해 사용하는 것이 권장되고 있는 옵션으로 그냥 끌수는 없다. 사실 문제가 해결된다는 보장도 없다(글쓴이도 정확하게 이해한 것이 아니라고 한다).</p>

<p>여기서 잠깐 <code>fast_shutdown</code>에 대해 조금 알아보자. <a href="http://php.net/manual/kr/opcache.configuration.php#ini.opcache.fast-shutdown">PHP 매뉴얼 OPcache 설치/설정</a>에 보면 아래와 같이 설명되어 있다.</p>

<blockquote>
  <p><strong>opcache.fast_shutdown boolean</strong></p>

  <p>If enabled, a fast shutdown sequence is used that doesn’t free each allocated block, but relies on the Zend Engine memory manager to deallocate the entire set of request variables en masse.</p>
</blockquote>

<p>정확한 의미는 모르겠지만 메뉴얼(<a href="http://php.net/manual/kr/opcache.installation.php">Recommended php.ini settings </a>) 상에서도 아래와 같이 <code>fast_shutdown</code>를 켜는 것을 권장하고 있다.</p>

<figure class='code'><div class="highlight notranslate"><pre><code class="nmcode">opcache.memory_consumption=128
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=4000
opcache.revalidate_freq=60
opcache.fast_shutdown=1
opcache.enable_cli=1
</code></pre></div></figure>

<p>다른 문서인 <a href="https://www.scalingphpbook.com/blog/2014/02/14/best-zend-opcache-settings.html">Best Zend OpCache Settings/Tuning/Config</a>에서도 켜는 것을 권장하고 있다. 따라서 이 옵션을 끄는 것도 보류.</p>

<p>현재 프로그램에서 의심되는 부분(다른 파일과 동일한 namespace와 class명을 사용)을 수정하고 opcache의 몇가지 옵션을 조정해서 다시 오류가 발생하는지 지켜보고 있다. 다시 오류가 재연되면 opcache 관리 페이지에서 전체 초기화가 아닌 파일 단위로 초기화하면서 원인 파일을 찾으려고 한다(진작에 했어야 하는 일이지만 서비스 중인 상태로 최대한 빨리 복구해야 해서 많은 시간을 들여 오류 위치를 찾을 수 없었다).</p>

<p>원인 파일을 찾고 나면 소스를 리뷰한 후 특별한 문제를 찾지 못할 경우 해당 파일만 opcache에서 제외시킬 계획이다.</p>

<p>제외하는 방법은 <code>opcache.blacklist_filename</code>에 지정된 파일에 해당 파일 경로를 추가하면 된다. 나의 경우는 <code>opcache.blacklist_filename = /etc/php.d/opcache*.blacklist</code>로 설정되어 있고 <code>/etc/php.d/opcache-default.blacklist</code> 파일이 기본적으로 생성되어 있다. 현재 테스트 서버에서 <code>/etc/php.d/opcache-default.blacklist</code>에 특정 파일 경로를 추가해서 opcache에서 정상적으로 제외되는지 확인은 마쳤다.</p>

<p>php를 10여년 넘게 써오면서 이런 경우는 처음이다. 프로그램을 수정한 부분으로 문제가 해결되었으면 하는 바람이다.</p>

<p><strong>첨부</strong></p>

<p>위 상황과는 관련이 없지만 불특정하게 발생하지 않는 일반적인 상황에서의 502 오류라면 <a href="https://gom2.net/502-bad-gateway-solution-on-nginx-php_fpm/">nginx + PHP-fpm에서 502 Bad gateway 에러 해결법 총정리</a>를 참고하면 도움이 될 것이다.</p>

			</article>
			<hr class="boundary">
		</div>

		<!-- adsense -->
		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<!-- 블로그 하단 -->
		<ins class="adsbygoogle"
			 style="display:block; margin-bottom:20px;"
			 data-ad-client="ca-pub-8163803188491150"
			 data-ad-slot="7841851420"
			 data-ad-format="auto"></ins>
		<script>
			(adsbygoogle = window.adsbygoogle || []).push({});
		</script>
		<!-- adsense -->

		<div class="pad-min"></div>
		<div id="post-comment" class="sheet post">
			<div id="disqus_thread"></div>
		</div>
	</div>
	<div class="content-navigation col-lg-3">
		<!-- I made it -->
		<section class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">I made it</h3>
			</div>
			<ul class="list-group">
				<li class="list-group-item"><a href="http://sprite.asamaru.net/" target="_blank">Sprite CSS/Image</a></li>
				<li class="list-group-item"><a href="http://loan.asamaru.net/" target="_blank">대출이자계산기</a></li>
				<li class="list-group-item"><a href="http://bookmarklet.asamaru.net/" target="_blank">북마클릿 생성기</a></li>
			</ul>
		</section>

		<!-- Categories -->
		
		
		<section class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">Categories</h3>
			</div>
			<ul class="list-group">
				
				<li class="list-group-item"><a href="/category/thinking/">Thinking <span class="badge">3</span></a></li>
				
				<li class="list-group-item"><a href="/category/osx/">Osx <span class="badge">5</span></a></li>
				
				<li class="list-group-item"><a href="/category/programming/">Programming <span class="badge">1</span></a></li>
				
				<li class="list-group-item"><a href="/category/css/">Css <span class="badge">3</span></a></li>
				
				<li class="list-group-item"><a href="/category/js/">Js <span class="badge">8</span></a></li>
				
				<li class="list-group-item"><a href="/category/android/">Android <span class="badge">53</span></a></li>
				
				<li class="list-group-item"><a href="/category/octopress/">Octopress <span class="badge">8</span></a></li>
				
				<li class="list-group-item"><a href="/category/ios/">Ios <span class="badge">18</span></a></li>
				
				<li class="list-group-item"><a href="/category/php/">Php <span class="badge">21</span></a></li>
				
				<li class="list-group-item"><a href="/category/java/">Java <span class="badge">5</span></a></li>
				
				<li class="list-group-item"><a href="/category/db/">Db <span class="badge">6</span></a></li>
				
				<li class="list-group-item"><a href="/category/html/">Html <span class="badge">1</span></a></li>
				
				<li class="list-group-item"><a href="/category/git/">Git <span class="badge">7</span></a></li>
				
				<li class="list-group-item"><a href="/category/blog/">Blog <span class="badge">1</span></a></li>
				
				<li class="list-group-item"><a href="/category/tip/">Tip <span class="badge">13</span></a></li>
				
				<li class="list-group-item"><a href="/category/linux/">Linux <span class="badge">26</span></a></li>
				
				<li class="list-group-item"><a href="/category/swift/">Swift <span class="badge">6</span></a></li>
				
				<li class="list-group-item"><a href="/category/iOS/">Ios <span class="badge">2</span></a></li>
				
				<li class="list-group-item"><a href="/category/vagrant/">Vagrant <span class="badge">5</span></a></li>
				
				<li class="list-group-item"><a href="/category/jekyll/">Jekyll <span class="badge">1</span></a></li>
				
			</ul>
		</section>
		
		

		<!-- Tags -->
		
		
		

		<!-- adsense -->
		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<!-- 블로그 우측 -->
		<ins class="adsbygoogle"
			 style="display:block; margin-bottom:20px;"
			 data-ad-client="ca-pub-8163803188491150"
			 data-ad-slot="1934918622"
			 data-ad-format="auto"></ins>
		<script>
			(adsbygoogle = window.adsbygoogle || []).push({});
		</script>
		<!-- adsense -->

		<!-- Related -->
		

		

		
		<section class="panel panel-default dRelatedPosts">
			<div class="panel-heading">
				<h3 class="panel-title">Related</h3>
			</div>
			<ul class="list-group">
				
				<li class="list-group-item"><a href="https://blog.asamaru.net/2016/07/04/php-composer-private-repository-and-proxy-toran-proxy/">PHP Composer : Private Repository / Proxy / 속도 향상(Toran Proxy를 사용한)</a></li>
				
				<li class="list-group-item"><a href="https://blog.asamaru.net/2016/03/25/php-invalid-sos-parameters-for-sequential-jpeg/">PHP - Invalid SOS parameters for sequential JPEG 오류 해결</a></li>
				
				<li class="list-group-item"><a href="https://blog.asamaru.net/2016/03/21/php7-and-gearman/">PHP 7에서 Gearman 모듈 사용하기</a></li>
				
				<li class="list-group-item"><a href="https://blog.asamaru.net/2016/03/17/php-composer-speed-up/">php composer 속도 개선하기</a></li>
				
				<li class="list-group-item"><a href="https://blog.asamaru.net/2016/03/11/upgrade-to-php-5-6-or-7-on-mac-osx-10-11-el-capitan-and-osx-10-6-10-10/">Mac OSX(10.6 – 10.11)에서 PHP(5.6 / 7) 업그레이드</a></li>
				
			</ul>
		</section>
		

		<section class="panel panel-default">
			<style>
				#google_translate_country { text-align:center; padding-top:5px; }
				#google_translate_element > div { text-align:center; padding:5px 0; }
				#google_translate_element > div > div { display:inline-block; *display:inline; *zoom:1; margin-right:10px; }
			</style>
			<div id="google_translate_country">
				<a href="#googtrans(ko|en)" onclick="setTimeout(function() { document.location.reload(); });"><img src="/static/img/lang/English.gif?w=660" alt="English"/></a>
				<!-- <a href="#googtrans(ko|ko)" onclick="setTimeout(function() { document.location.reload(); });"><img src="/static/img/lang/Korean.gif?w=660" alt="Korean"/></a> -->
				<a href="#googtrans(ko|zh-CN)" onclick="setTimeout(function() { document.location.reload(); });"><img src="/static/img/lang/Chinese.gif?w=660" alt="Chinese"/></a>
				<a href="#googtrans(ko|ja)" onclick="setTimeout(function() { document.location.reload(); });"><img src="/static/img/lang/Japanese.gif?w=660" alt="Japanese"/></a>
				<a href="#googtrans(ko|fr)" onclick="setTimeout(function() { document.location.reload(); });"><img src="/static/img/lang/French.gif?w=660" alt="French"/></a>
				<a href="#googtrans(ko|de)" onclick="setTimeout(function() { document.location.reload(); });"><img src="/static/img/lang/German.gif?w=660" alt="German"/></a>
				<a href="#googtrans(ko|it)" onclick="setTimeout(function() { document.location.reload(); });"><img src="/static/img/lang/Italian.gif?w=660" alt="Italian"/></a>
			</div>
			<div id="google_translate_element"></div>
			<script type="text/javascript">
				function googleTranslateElementInit() {
					new google.translate.TranslateElement({pageLanguage: 'ko'}, 'google_translate_element');
				}
			</script>
			<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
		</section>
	</div>
</div>


		
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			var disqus_shortname = 'asamaru7'; // required: replace example with your forum shortname
			// var disqus_developer = 1; // Comment out when the site is live
			var disqus_identifier = "/2016/04/12/php-fpm-opcache-and-nginx-502-bad-gateaway/";

			/* * * DON'T EDIT BELOW THIS LINE * * */
			(function () {
				var dsq = document.createElement('script');
				dsq.type = 'text/javascript';
				dsq.async = true;
				dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
		
	</div>

	<div class="page-scrollTop" data-toggle="tooltip" data-placement="top" title="Top">
		<a href="javascript:void(0);">
			<div class="arrow"></div>
			<div class="stick"></div>
		</a>
	</div>
</div>

<footer class="footnote footnote-tiffany">
	<div class="container">
		<a class="foot-item" href="mailto:asamaru@asamaru.net" target="_blank"><img src="/static/img/bottom-email.png" alt="Email"></a>
		<a class="foot-item" href="https://github.com/asamaru7" target="_blank"><img src="/static/img/bottom-github.png" alt="Github"></a>
		<a class="foot-item" href="https://blog.asamaru.net/atom.xml" target="_blank"><img src="/static/img/bottom-rss.png" alt="RSS"></a>
		&nbsp;
		<a href="https://blog.asamaru.net"><span class="word-keep">&copy; 유영재</span></a>
	</div>
</footer>


<div class="scriptHub">
	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
	<script type="text/javascript" src="https://blog.asamaru.net/static/js/script.js"></script>

	
	<script type="text/javascript" src="https://blog.asamaru.net/static/js/post.js"></script>
	
	
</div>



</body>
</html>
